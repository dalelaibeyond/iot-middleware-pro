# message_map_spec

# Message Map - Field Reference

> **Version:** 2.0.0
> 
> 
> **Purpose:** Quick reference for message field transformations through the pipeline
> 
> **Pipeline:** RAW → SIF → SUO → DB
> 

---

## Overview

| Stage | Format | Module | Description |
| --- | --- | --- | --- |
| **RAW** | Binary/JSON | `MqttSubscriber` | Device payload |
| **SIF** | Object | `V5008Parser`, `V6800Parser` | Standard Intermediate Format |
| **SUO** | Object | `UnifyNormalizer` | Standard Unified Object |
| **DB** | SQL | `StorageService` | MySQL tables |

---

## Message Type Matrix

| Message Type | V5008 | V6800 | SUO Type | DB Table |
| --- | --- | --- | --- | --- |
| `HEARTBEAT` | 0xCC/0xCB | `heart_beat_req` | `HEARTBEAT` | `iot_heartbeat` |
| `RFID_SNAPSHOT` | 0xBB | `u_state_resp` | `RFID_SNAPSHOT` | `iot_rfid_snapshot` |
| `RFID_EVENT` | (diff) | `u_state_changed_notify_req` | `RFID_EVENT` | `iot_rfid_event` |
| `TEMP_HUM` | `/TemHum` | `temper_humidity_*` | `TEMP_HUM` | `iot_temp_hum` |
| `NOISE_LEVEL` | `/Noise` | N/A | `NOISE_LEVEL` | `iot_noise_level` |
| `DOOR_STATE` | 0xBA | `door_state_changed_*` | `DOOR_STATE` | `iot_door_event` |
| `DEVICE_METADATA` | 0xEF01/0xEF02 | `devies_init_req` | `DEVICE_METADATA` | `iot_meta_data` |
| `META_CHANGED_EVENT` | N/A | `devices_changed_req` | `META_CHANGED_EVENT` | `iot_topchange_event` |
| `QRY_CLR_RESP` | 0xAA+0xE4 | `u_color` | `QRY_CLR_RESP` | `iot_cmd_result` |
| `SET_CLR_RESP` | 0xAA+0xE1 | `set_module_property_result_req` | `SET_CLR_RESP` | `iot_cmd_result` |
| `CLN_ALM_RESP` | 0xAA+0xE2 | `clear_u_warning` | `CLN_ALM_RESP` | `iot_cmd_result` |

---

## Field Name Mappings

### Sensor Indices

| Sensor Type | SIF Field | SUO Field | DB Column Pattern |
| --- | --- | --- | --- |
| Temperature/Humidity | `thIndex` | `sensorIndex` | `temp_indexXX`, `hum_indexXX` (XX=10-15) |
| Noise | `nsIndex` | `sensorIndex` | `noise_indexXX` (XX=16-18) |
| RFID | `uIndex` | `sensorIndex` | `sensor_index` |

### Module Fields

| Stage | Module Index | Module ID |
| --- | --- | --- |
| RAW (V5008) | `ModAddr` | `ModId` |
| RAW (V6800) | `module_index` | `module_sn` |
| SIF | `moduleIndex` | `moduleId` |
| SUO | `moduleIndex` | `moduleId` |
| DB | `module_index` | In `modules` JSON |

---

## Message Type Details

### 1. HEARTBEAT

**V5008 Binary → SIF:**

```
Offset 0:     Header (0xCC or 0xCB)
Offset 1+i×6: ModAddr → moduleIndex
Offset 2+i×6: ModId (4 bytes BE) → moduleId
Offset 6+i×6: Total → uTotal
Last 4 bytes: MsgId → messageId
```

**V6800 JSON → SIF:**

```json
{
  "msg_type": "heart_beat_req",
  "gateway_sn": "→ deviceId",
  "uuid_number": "→ messageId",
  "data": [{"module_index": 0, "module_sn": "...", "module_u_num": 6}]
}
```

**SUO → DB:**

```sql
INSERT INTO iot_heartbeat (device_id, modules, parse_at)
VALUES ('V5008_001', '[{"moduleIndex":1,"moduleId":"...","uTotal":6}]', NOW(3));
```

---

### 2. RFID_SNAPSHOT

**V5008 Binary → SIF:**

```
Offset 0:     Header (0xBB)
Offset 1:     ModAddr → moduleIndex
Offset 2:     ModId (4 bytes) → moduleId
Offset 7:     Total → uTotal
Offset 8:     Count → onlineCount
Offset 9+i×6: uPos → uIndex
Offset 10+i×6: Alarm → isAlarm
Offset 11+i×6: TagId (4 bytes) → tagId
```

**V6800 JSON → SIF:**

```json
{
  "msg_type": "u_state_resp",
  "data": [{
    "module_index": 0,
    "data": [{"u_index": 1, "tag_code": "...", "warning": false}]
  }]
}
```

**SUO → DB:**

```sql
INSERT INTO iot_rfid_snapshot (device_id, module_index, rfid_snapshot, parse_at)
VALUES ('V5008_001', 1, '[{"sensorIndex":1,"tagId":"...","isAlarm":false}]', NOW(3));
```

---

### 3. RFID_EVENT

**V5008:** Generated by `UnifyNormalizer.diffRfidSnapshots()` when snapshot changes.

**V6800 JSON → SIF:**

```json
{
  "msg_type": "u_state_changed_notify_req",
  "data": [{"data": [{"u_index": 1, "tag_code": "...", "new_state": 1, "old_state": 0}]}]
}
```

- `new_state=1, old_state=0` → `action: "ATTACHED"`
- `new_state=0, old_state=1` → `action: "DETACHED"`

**SUO → DB:**

```sql
INSERT INTO iot_rfid_event (device_id, module_index, sensor_index, tag_id, action, alarm, parse_at)
VALUES ('V6800_001', 0, 1, 'AABBCCDD', 'ATTACHED', FALSE, NOW(3));
```

---

### 4. TEMP_HUM

**V5008 Binary → SIF:**

```
Offset 0:     ModAddr → moduleIndex
Offset 1:     ModId (4 bytes) → moduleId
Offset 5+i×5: Addr → thIndex (1-6, mapped to 10-15)
Offset 6+i×5: T_Int (signed) + T_Frac → temp
Offset 8+i×5: H_Int (signed) + H_Frac → hum
```

**Algorithm A (Signed Sensor Values):**
- If both int/frac bytes are 0x00 → return `null`
- Check sign bit (0x80) for two’s complement
- Combine: `signedInt + sign × (fraction / 100)`
- Round to 2 decimal places

**V6800 JSON → SIF:**

```json
{
  "data": [{"data": [{"temper_position": 1, "temper_swot": 25.5, "hygrometer_swot": 60.0}]}]
}
```

- Values of `0` are converted to `null`

**SUO → DB (Pivoted):**

```sql
INSERT INTO iot_temp_hum (device_id, module_index, temp_index10, hum_index10, parse_at)
VALUES ('V5008_001', 1, 25.5, 60.0, NOW(3));
```

- `thIndex` 1-6 → `sensorIndex` 10-15
- Filter: Readings with both temp and hum as 0/null are skipped

---

### 5. NOISE_LEVEL (V5008 only)

**V5008 Binary → SIF:**

```
Offset 0:     ModAddr → moduleIndex
Offset 1:     ModId (4 bytes) → moduleId
Offset 5+i×3: Addr → nsIndex (1-3, mapped to 16-18)
Offset 6+i×3: N_Int (signed) + N_Frac → noise
```

Uses **Algorithm A** (same as TEMP_HUM).

**SUO → DB (Pivoted):**

```sql
INSERT INTO iot_noise_level (device_id, module_index, noise_index16, parse_at)
VALUES ('V5008_001', 1, 45.5, NOW(3));
```

- `nsIndex` 1-3 → `sensorIndex` 16-18

---

### 6. DOOR_STATE

**V5008 Binary → SIF:**

```
Offset 0: Header (0xBA)
Offset 1: ModAddr → moduleIndex
Offset 2: ModId (4 bytes) → moduleId
Offset 6: State → doorState
```

**V6800 JSON → SIF:**

```json
{
  "data": [{
    "module_index": 0,
    "new_state": 1,
    "new_state1": 1,
    "new_state2": 0
  }]
}
```

- Maps to: `doorState`, `door1State`, `door2State`

**SUO → DB:**

```sql
INSERT INTO iot_door_event (device_id, module_index, doorState, door1State, door2State, parse_at)
VALUES ('V5008_001', 1, 1, NULL, NULL, NOW(3));
```

---

### 7. DEVICE_METADATA

**V5008 DEVICE_INFO (0xEF01) → SIF:**

```
Offset 2:  Model (2 bytes) → model
Offset 4:  Fw (4 bytes) → fwVer
Offset 8:  IP (4 bytes) → ip
Offset 12: Mask (4 bytes) → mask
Offset 16: Gw (4 bytes) → gwIp
Offset 20: Mac (6 bytes) → mac
```

**V5008 MODULE_INFO (0xEF02) → SIF:**

```
Offset 2+i×5: ModAddr → moduleIndex
Offset 3+i×5: Fw (4 bytes) → fwVer
```

**V6800 DEV_MOD_INFO → SIF:**

```json
{
  "msg_type": "devies_init_req",
  "gateway_ip": "→ ip",
  "gateway_mac": "→ mac",
  "data": [{"module_index": 0, "module_sn": "...", "module_sw_version": "...", "module_u_num": 6}]
}
```

**SUO → DB (UPSERT):**

```sql
INSERT INTO iot_meta_data (device_id, device_type, device_fwVer, device_ip, device_mac, modules, parse_at, update_at)
VALUES ('V5008_001', 'V5008', '...', '...', '...', '[{...}]', NOW(3), NOW(3))
ON DUPLICATE KEY UPDATE device_fwVer=VALUES(device_fwVer), ...;
```

---

### 8. Command Responses

**V5008 QRY_CLR_RESP (0xAA+0xE4) → SIF:**

```
Offset 6:  Result (0xA1 = Success)
Offset 7:  OriginalReq (echoed)
Offset 8:  ModuleIndex
Offset 9+: Color codes array
```

**V6800 QRY_CLR_RESP → SIF:**

```json
{
  "msg_type": "u_color",
  "data": [{"data": [{"u_index": 1, "color": "Red", "code": 1}]}]
}
```

**SUO → DB:**

```sql
INSERT INTO iot_cmd_result (device_id, cmd, result, original_req, color_map, parse_at)
VALUES ('V5008_001', 'QRY_CLR_RESP', 'Success', 'E401', '[1,2,3]', NOW(3));
```

---

## Database Schema Summary

| Table | Key Fields | Indexes |
| --- | --- | --- |
| `iot_meta_data` | device_id, device_type, device_ip, device_mac, modules (JSON) | uk_device_id, idx_meta_type |
| `iot_heartbeat` | device_id, modules (JSON), parse_at | idx_hb |
| `iot_rfid_snapshot` | device_id, module_index, rfid_snapshot (JSON), parse_at | idx_rfid_snap |
| `iot_rfid_event` | device_id, module_index, sensor_index, tag_id, action, parse_at | idx_rfid_evt, idx_rfid_device |
| `iot_temp_hum` | device_id, module_index, temp_index10-15, hum_index10-15, parse_at | idx_th |
| `iot_noise_level` | device_id, module_index, noise_index16-18, parse_at | idx_noise |
| `iot_door_event` | device_id, module_index, doorState, door1State, door2State, parse_at | idx_door |
| `iot_cmd_result` | device_id, cmd, result, original_req, color_map (JSON), parse_at | idx_cmd |
| `iot_topchange_event` | device_id, device_type, event_desc, parse_at, update_at | idx_top_chng |

---

## Related Documentation

| Document | Location | Content |
| --- | --- | --- |
| Architecture Spec | `docs/middleware_spec.md` | System architecture, API, commands |
| Normalizer Spec | `docs/normalizer_spec.md` | SUO conversion, SmartHeartbeat |
| V5008 Parser Spec | `docs/v5008_parser_spec.md` | Binary protocol details |
| V6800 Parser Spec | `docs/v6800_parser_spec.md` | JSON protocol details |
| Dashboard Spec | `docs/dashboard_spec.md` | React frontend spec |
| Database Schema | `database/schema.sql` | Full SQL schema |

---

**Last Updated:** 2026-02-12

**Maintainer:** IoT Middleware Pro Team